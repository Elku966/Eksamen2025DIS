<!DOCTYPE html>
<html lang="da">
<head>
  <meta charset="UTF-8">
  <title>Booking - SMS-påmindelse</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="/stylesheets/checkout.css">
</head>

<body>
  <!--Baggrundsvideo-->
  <div class="video-baggrund">
    <iframe
      src="https://www.youtube.com/embed/kSJ8D8S5B9s?autoplay=1&mute=1&controls=0&loop=1&playlist=kSJ8D8S5B9s&modestbranding=1&showinfo=0"
      frameborder="0"
      allow="autoplay; fullscreen"
      allowfullscreen
    ></iframe>
  </div>


  <div class="indhold"> <!--Kort intro til formularen-->
    <h1 id="overskrift">Afslut din booking</h1>
    <p class="undertekst">
      Udfyld felterne. Sæt flueben hvis du vil have en SMS-påmindelse 24 timer før.
    </p>

    <!--Bookingformular-->
    <form id="booking-formular">
      <label for="navn">Navn</label>
      <input id="navn" type="text" required>

      <label for="dato">Dato</label>
      <input id="dato" type="date" max="2027-12-31" required>

      <label for="tid">Tidspunkt</label>
      <select id="tid" required>
        <option value="">Vælg tidspunkt</option>
        <option>09:00</option>
        <option>10:30</option>
        <option>12:00</option>
        <option>13:30</option>
        <option>15:00</option>
        <option>16:30</option>
        <option>18:00</option>
        <option>19:30</option>
      </select>

      <!--Aktiviteten bliver automatisk udfyldt fra URL'en-->
      <label for="aktivitet">Aktivitet</label>
      <input id="aktivitet" type="text" readonly>

      <!--Lokationen udfyldes automatisk ud fra aktiviteten-->
      <label for="lokation">Lokation</label>
      <input id="lokation" type="text" readonly>

      <label for="antal">Antal personer</label>
      <input id="antal" type="number" min="1" value="1" required>

      <!--Automatisk beregnet pris ud fra antal-->
      <label for="total-pris">Samlet pris</label>
      <input id="total-pris" type="text" readonly placeholder="Beregn pris ud fra antal">

      <label for="telefon">Telefon</label>
      <input
        id="telefon"
        type="tel"
        inputmode="numeric"
        pattern="[0-9+ ]{8,16}"
        placeholder="+45 12 34 56 78"
        required
      >

      <!--Mulighed for SMS påmindelse-->
      <div class="afkrydsning">
        <input id="sms-påmindelse" type="checkbox">
        <label for="sms-påmindelse">Ja tak, send SMS-påmindelse</label>
      </div>

      <!--Mulighed for bemærkning-->
      <span class="bemærkning-knap" id="åbn-bemærkning">Eventuelle bemærkninger</span>
      <textarea id="bemærkning-felt" placeholder="Skriv din kommentar her..."></textarea>

      <button type="submit">Bekræft booking</button>
    </form>

    <p id="besked"></p>
  </div>


  <script>
    //Liste over lokationer der er koblet til aktiviteter
    const LOKATIONER = {
      "Yoga undervisning": "Thorvaldsensvej 3, 1871 Frederiksberg C",
      "Keramikværksted": "Borups Allé 29, 2200 København N",
      "Vinsmagning": "Gammel Mønt 4, 1117 København K",
      "Flødebollekursus": "Ordrupvej 42, 2920 Charlottenlund",
      "Pilates": "Guldbergsgade 29A, 2. 2200 København N",
      "Cocktailkursus": "Kløvermarksvej 70 D, 2300 Copenhagen, Denmark",
      "Bolsjekursus": "Værkstedsgården 13, 2620 Albertslund",
      "Klatring": "Vildnisset i Søndermarken, 2000 Frederiksberg",
    };

    //Opdater lokationen når aktiviteten ændre sig 
    function opdaterLokation() {
      const aktivitet = document.getElementById('aktivitet').value;
      document.getElementById('lokation').value = LOKATIONER[aktivitet] || "";
    }

    //Sørger for at datoen ikke kan sættes før dagens dato
    (function () {
      const nu = new Date();
      const y = nu.getFullYear();
      const m = String(nu.getMonth() + 1).padStart(2, "0");
      const d = String(nu.getDate()).padStart(2, "0");
      const minDato = `${y}-${m}-${d}`;
      document.getElementById("dato").setAttribute("min", minDato);
    })();

    //Hvis brugeren vælger idag, skjules passerede tider
    document.getElementById('dato').addEventListener('change', function () {
      const valgtDato = this.value;
      const nu = new Date();
      const tidSelect = document.getElementById('tid');
      const alleOptioner = tidSelect.querySelectorAll("option");

      //Når datoen ændres vis alle tiderne igen og skjul dem der allerede er passeret 
      alleOptioner.forEach(opt => opt.hidden = false);

      if (!valgtDato) return;

      const iDag = nu.toISOString().split("T")[0];

      if (valgtDato === iDag) {
        const nuTimer = nu.getHours();
        const nuMin = nu.getMinutes();

        alleOptioner.forEach(opt => {
          if (!opt.value) return;
          const [h, m] = opt.value.split(":").map(Number);
          if (h < nuTimer || (h === nuTimer && m < nuMin)) {
            opt.hidden = true;
          }
        });
      }

      tidSelect.value = "";
    });

    //Standardpriser for aktiviteterne
    const PRISER = {
      "Yoga undervisning": 199,
      "Keramikværksted": 249,
      "Vinsmagning": 449,
      "Flødebollekursus": 229,
      "Pilates": 149,
      "Cocktailkursus": 399,
      "Bolsjekursus": 199,
      "Klatring": 229
    };

    //Beregner totalpris ud fra antal personer
    function opdaterPris() {
      const aktivitet = document.getElementById('aktivitet').value;
      const antal = parseInt(document.getElementById('antal').value, 10) || 0;
      const total = (PRISER[aktivitet] || 0) * antal;
      document.getElementById('total-pris').value =
        total > 0 ? total.toLocaleString("da-DK") + " kr." : "";
    }

    //Henter aktivitet fra URL og indsætter både aktivitet og adresse
    (function () {
      const params = new URLSearchParams(window.location.search);
      const eventNavn = params.get('event');
      const overskrift = document.getElementById('overskrift');
      const aktivitetInput = document.getElementById('aktivitet');

      if (eventNavn && aktivitetInput) {
        overskrift.textContent = "Afslut din booking for " + eventNavn;
        aktivitetInput.value = eventNavn;
        opdaterLokation(); 
      } else {
        aktivitetInput.value = "";
        document.getElementById('lokation').value = "";
      }

      opdaterPris();
    })();

    document.getElementById('antal').addEventListener('input', opdaterPris);

    //Fold bemærkningsfeltet ind og ud ved klik
    document.getElementById('åbn-bemærkning').addEventListener('click', () => {
      const felt = document.getElementById('bemærkning-felt');
      felt.style.display = felt.style.display === 'block' ? 'none' : 'block';
    });

    //Når brugeren indsender bookingformularen, sendes data til backend
    document.getElementById('booking-formular').addEventListener('submit', async function (e) {
      e.preventDefault();

      const besked = document.getElementById('besked');

      //Pakker alle brugeren oplysninger i et objekt 
      const data = {
        navn: document.getElementById('navn').value,
        dato: document.getElementById('dato').value,
        tid: document.getElementById('tid').value,
        aktivitet: document.getElementById('aktivitet').value,
        lokation: document.getElementById('lokation').value,
        antal: document.getElementById('antal').value,
        totalPris: document.getElementById('total-pris').value,
        telefon: document.getElementById('telefon').value,
        bemærkning: document.getElementById('bemærkning-felt').value,
        smsPaamindelse: document.getElementById('sms-påmindelse').checked
      };

      try {
        const res = await fetch('/checkout', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });

        if (!res.ok) {
          besked.textContent = "Serverfejl: " + res.status;
          return;
        }

        //Send brugeren videre til betalingsside med bookingdata som query parametre
        const activityParams = new URLSearchParams({
          aktivitet: data.aktivitet,
          antal: data.antal,
          dato: data.dato,
          tid: data.tid
        });

        window.location.href = "/checkout/betaling?" + activityParams.toString();

      } catch (err) {
        console.error(err);
        besked.textContent = "Netværksfejl - kunne ikke kontakte serveren.";
      }
    });
  </script>
</body>
</html>
