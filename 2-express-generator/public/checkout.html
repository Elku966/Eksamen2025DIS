<!DOCTYPE html>
<html lang="da">
<head>
  <meta charset="UTF-8">
  <title>Booking - SMS-påmindelse</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --baggrund: #f4f7f6;      
      --tekst: #20312c;     
      --dæmpet: #5c6e68;     
      --primær: #2f6f60;   
      --primær-hover: #275b4e;
      --kant: #dfe7e4;    
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      padding: 0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color: var(--tekst);
      background: var(--baggrund);
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      overflow: hidden;
    }

    .video-baggrund {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      overflow: hidden;
      z-index: -1;
    }

    .video-baggrund iframe {
      position: absolute;
      top: 50%;
      left: 50%;
      width: 120vw;
      height: 120vh;
      transform: translate(-50%, -50%);
      pointer-events: none;
    }

    .indhold {
      width: 90%;
      max-width: 400px;
      background: rgba(255, 255, 255, 0.9);
      border: 1px solid rgba(255,255,255,0.3);
      border-radius: 14px;
      padding: 20px 22px;
      box-shadow: 0 4px 18px rgba(0,0,0,0.18);
      backdrop-filter: blur(8px);
    }

    h1 {
      margin: 0 0 6px;
      font-size: 1.3rem;
      text-align: center;
    }

    .undertekst {
      margin: 0 0 14px;
      color: var(--dæmpet);
      font-size: 0.9rem;
      text-align: center;
    }

    label { 
      display: block;
      margin: 8px 0 5px;
      font-weight: 600;
    }

    input, textarea, select {
      width: 100%;
      padding: 8px 10px;
      border: 1px solid var(--kant);
      border-radius: 8px;
      font-size: 1rem;
      color: var(--tekst);
      background: #fff;
      outline: none;
      resize: none;
    }

    input:focus, textarea:focus, select:focus { border-color: var(--primær); }

    .afkrydsning {
      display: flex;
      align-items: center;
      justify-content: flex-start;
      gap: 8px;
      margin: 12px 0 0 -100px;
      color: var(--dæmpet);
      font-weight: 500;
    }

    button {
      background-color: #DDF291;
      color: #16361C;
      border: none;
      border-radius: 25px;
      padding: 12px;
      font-size: 1rem;
      font-weight: 600;
      width: 100%;
      cursor: pointer;
      transition: background-color 0.2s ease;
      margin-top: 16px;
    }

    button:hover {
      background-color: #c8e87d;
    }

    #besked {
      margin-top: 10px;
      font-weight: 600;
      color: var(--dæmpet);
      text-align: center;
    }

    .bemærkning-knap {
      color: var(--primær);
      text-decoration: underline;
      cursor: pointer;
      font-size: 0.9rem;
      display: inline-block;
      margin-top: 10px;
    }

    #bemærkning-felt {
      display: none;
      margin-top: 6px;
      height: 40px;
      font-size: 0.9rem;
      font-family: Arial, Helvetica, sans-serif;
    }
  </style>
</head>

<body>
  <div class="video-baggrund">
    <iframe
      src="https://www.youtube.com/embed/kSJ8D8S5B9s?autoplay=1&mute=1&controls=0&loop=1&playlist=kSJ8D8S5B9s&modestbranding=1&showinfo=0"
      frameborder="0"
      allow="autoplay; fullscreen"
      allowfullscreen
    ></iframe>
  </div>

  <div class="indhold">
    <h1 id="overskrift">Afslut din booking</h1>
    <p class="undertekst">Udfyld felterne. Sæt flueben hvis du vil have en SMS-påmindelse 24 timer før.</p>

    <form id="booking-formular">
      <label for="navn">Navn</label>
      <input id="navn" type="text" required>

      <label for="dato">Dato</label>
      <input id="dato" type="date" required>

      <label for="tid">Tidspunkt</label>
      <select id="tid" required>
        <option value="">Vælg tidspunkt</option>
        <option>09:00</option>
        <option>10:30</option>
        <option>12:00</option>
        <option>13:30</option>
        <option>15:00</option>
        <option>16:30</option>
        <option>18:00</option>
        <option>19:30</option>
      </select>

      <!-- NYT: aktivitet (kun læsbar, udfyldes fra ?event=) -->
      <label for="aktivitet">Aktivitet</label>
      <input id="aktivitet" type="text" readonly>

      <!-- NYT: antal personer -->
      <label for="antal">Antal personer</label>
      <input id="antal" type="number" min="1" value="1" required>

      <!-- NYT: samlet pris -->
      <label for="total-pris">Samlet pris</label>
      <input id="total-pris" type="text" readonly placeholder="Beregn pris ud fra antal">

      <label for="telefon">Telefon</label>
      <input id="telefon" type="tel" placeholder="Indtast telefonnummer" required>

      <div class="afkrydsning">
        <input id="sms-påmindelse" type="checkbox">
        <label for="sms-påmindelse">Ja tak, send SMS-påmindelse</label>
      </div>

      <span class="bemærkning-knap" id="åbn-bemærkning">Eventuelle bemærkninger</span>
      <textarea id="bemærkning-felt" placeholder="Skriv din kommentar her..."></textarea>

      <button type="submit">Bekræft booking</button>
    </form>

    <p id="besked"></p>
  </div>

  <script>
    // Pris pr. person for hver aktivitet
    const PRISER = {
      "Yoga undervisning": 199,
      "Keramikværksted": 249,
      "Vinsmagning": 449,
      "Flødebollekursus": 229,
      "Pilates": 149,
      "Cocktailkursus": 399,
      "Bolsjekursus": 199,
      "Klatring": 229
    };

    function opdaterPris() {
      const aktivitet = document.getElementById('aktivitet').value;
      const antalInput = document.getElementById('antal');
      const totalFelt = document.getElementById('total-pris');

      const antal = parseInt(antalInput.value, 10) || 0;
      const prisPerPerson = PRISER[aktivitet] || 0;
      const total = prisPerPerson * antal;

      if (prisPerPerson && antal > 0) {
        totalFelt.value = total.toLocaleString('da-DK') + ' kr.';
      } else {
        totalFelt.value = '';
      }
    }

    // Sæt overskrift + aktivitet ud fra ?event= i URL'en
    (function () {
      const params = new URLSearchParams(window.location.search);
      const eventNavn = params.get('event');
      const overskrift = document.getElementById('overskrift');
      const aktivitetInput = document.getElementById('aktivitet');

      if (eventNavn && overskrift) {
        overskrift.textContent = 'Afslut din booking for ' + eventNavn;
      }

      if (eventNavn && aktivitetInput) {
        aktivitetInput.value = eventNavn;
      }

      // Beregn startpris (standard 1 person)
      opdaterPris();
    })();

    document.getElementById('antal').addEventListener('input', opdaterPris);

    document.getElementById('åbn-bemærkning').addEventListener('click', () => {
      const felt = document.getElementById('bemærkning-felt');
      felt.style.display = (felt.style.display === 'block') ? 'none' : 'block';
    });

    document.getElementById('booking-formular').addEventListener('submit', async function (e) {
      e.preventDefault();

      const smsPåmindelse = document.getElementById('sms-påmindelse').checked;
      const besked = document.getElementById('besked');

      const aktivitet = document.getElementById('aktivitet').value;
      const antal = document.getElementById('antal').value;
      const totalPris = document.getElementById('total-pris').value;

      const data = {
        navn: document.getElementById('navn').value,
        dato: document.getElementById('dato').value,
        tid: document.getElementById('tid').value,
        aktivitet: aktivitet,
        antal: antal,
        totalPris: totalPris,
        telefon: document.getElementById('telefon').value,
        bemærkning: document.getElementById('bemærkning-felt').value
      };

      // Byg query-string til gennemført-side (så vi kan vise opsummering)
      const query = new URLSearchParams({
        aktivitet: aktivitet,
        antal: antal,
        total: totalPris
      }).toString();

      if (!smsPåmindelse) {
        window.location.href = "/checkout/gennemfoert?" + query;
        return;
      }

      try {
        const res = await fetch('/sms/send', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });

        const result = await res.json();

        if (result.success) {
          window.location.href = "/checkout/gennemfoert?" + query;
        } else {
          besked.textContent = "Kunne ikke sende SMS";
        }

      } catch (err) {
        console.error(err);
        besked.textContent = "Netværksfejl - kunne ikke kontakte serveren.";
      }
    });
  </script>

</body>
</html>
