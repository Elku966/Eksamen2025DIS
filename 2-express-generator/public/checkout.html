<!DOCTYPE html>
<html lang="da">
<head>
  <meta charset="UTF-8">
  <title>Booking - SMS-p√•mindelse</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <link rel="stylesheet" href="/stylesheets/checkout.css">
</head>

<body>
  <div class="video-baggrund">
    <iframe
      src="https://www.youtube.com/embed/kSJ8D8S5B9s?autoplay=1&mute=1&controls=0&loop=1&playlist=kSJ8D8S5B9s&modestbranding=1&showinfo=0"
      frameborder="0"
      allow="autoplay; fullscreen"
      allowfullscreen
    ></iframe>
  </div>

  <div class="indhold">
    <h1 id="overskrift">Afslut din booking</h1>
    <p class="undertekst">
      Udfyld felterne. S√¶t flueben hvis du vil have en SMS-p√•mindelse 24 timer f√∏r.
    </p>

    <form id="booking-formular">
      <label for="navn">Navn</label>
      <input id="navn" type="text" required>

      <label for="dato">Dato</label>
      <!-- Max sat til sidste dag i 2027 -->
      <input id="dato" type="date" max="2027-12-31" required>

      <label for="tid">Tidspunkt</label>
      <select id="tid" required>
        <option value="">V√¶lg tidspunkt</option>
        <option>09:00</option>
        <option>10:30</option>
        <option>12:00</option>
        <option>13:30</option>
        <option>15:00</option>
        <option>16:30</option>
        <option>18:00</option>
        <option>19:30</option>
      </select>

      <!-- Aktivitet (kun l√¶sbar, udfyldes fra ?event=) -->
      <label for="aktivitet">Aktivitet</label>
      <input id="aktivitet" type="text" readonly>

      <!-- Antal personer -->
      <label for="antal">Antal personer</label>
      <input id="antal" type="number" min="1" value="1" required>

      <!-- Samlet pris (vises kun her, ikke p√• gennemf√∏rt-siden) -->
      <label for="total-pris">Samlet pris</label>
      <input id="total-pris" type="text" readonly placeholder="Beregn pris ud fra antal">

      <!-- üì± Telefon ‚Äì nu √©t enkelt felt -->
      <label for="telefon">Telefon</label>
      <input
        id="telefon"
        type="tel"
        inputmode="numeric"
        pattern="[0-9+ ]{8,16}"
        placeholder="+45 12 34 56 78"
        required
      >

      <div class="afkrydsning">
        <input id="sms-p√•mindelse" type="checkbox">
        <label for="sms-p√•mindelse">Ja tak, send SMS-p√•mindelse</label>
      </div>

      <span class="bem√¶rkning-knap" id="√•bn-bem√¶rkning">Eventuelle bem√¶rkninger</span>
      <textarea id="bem√¶rkning-felt" placeholder="Skriv din kommentar her..."></textarea>

      <button type="submit">Bekr√¶ft booking</button>
    </form>

    <p id="besked"></p>
  </div>

  <script>
    // Pris pr. person for hver aktivitet
    const PRISER = {
      "Yoga undervisning": 199,
      "Keramikv√¶rksted": 249,
      "Vinsmagning": 449,
      "Fl√∏debollekursus": 229,
      "Pilates": 149,
      "Cocktailkursus": 399,
      "Bolsjekursus": 199,
      "Klatring": 229
    };

    function opdaterPris() {
      const aktivitet = document.getElementById('aktivitet').value;
      const antalInput = document.getElementById('antal');
      const totalFelt = document.getElementById('total-pris');

      const antal = parseInt(antalInput.value, 10) || 0;
      const prisPerPerson = PRISER[aktivitet] || 0;
      const total = prisPerPerson * antal;

      if (prisPerPerson && antal > 0) {
        totalFelt.value = total.toLocaleString('da-DK') + ' kr.';
      } else {
        totalFelt.value = '';
      }
    }

    // S√¶t overskrift + aktivitet ud fra ?event= i URL'en
    (function () {
      const params = new URLSearchParams(window.location.search);
      const eventNavn = params.get('event');
      const overskrift = document.getElementById('overskrift');
      const aktivitetInput = document.getElementById('aktivitet');

      if (eventNavn && overskrift) {
        overskrift.textContent = 'Afslut din booking for ' + eventNavn;
      }

      if (eventNavn && aktivitetInput) {
        aktivitetInput.value = eventNavn;
      }

      // Beregn startpris (standard 1 person)
      opdaterPris();
    })();

    document.getElementById('antal').addEventListener('input', opdaterPris);

    document.getElementById('√•bn-bem√¶rkning').addEventListener('click', () => {
      const felt = document.getElementById('bem√¶rkning-felt');
      felt.style.display = (felt.style.display === 'block') ? 'none' : 'block';
    });

    // H√•ndter submit af booking-formularen
    document.getElementById('booking-formular').addEventListener('submit', async function (e) {
      e.preventDefault();

      const besked = document.getElementById('besked');
      const smsP√•mindelse = document.getElementById('sms-p√•mindelse').checked;

      const aktivitet = document.getElementById('aktivitet').value;
      const antal = document.getElementById('antal').value;
      const totalPris = document.getElementById('total-pris').value;
      const dato = document.getElementById('dato').value;
      const tid = document.getElementById('tid').value;

      const data = {
        navn: document.getElementById('navn').value,
        dato,
        tid,
        aktivitet,
        antal,
        totalPris,
        telefon: document.getElementById('telefon').value,
        bem√¶rkning: document.getElementById('bem√¶rkning-felt').value,
        smsPaamindelse: smsP√•mindelse
      };

      try {
        const res = await fetch('/checkout', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });

        if (!res.ok) {
          console.error('Serverfejl:', res.status);
          besked.textContent = "Serverfejl: " + res.status;
          return;
        }

        // Vi kan l√¶se svaret hvis vi vil logge det, men vi bruger ikke felterne til URL'en
        const result = await res.json();
        console.log('Svar fra /checkout:', result);

        // Hvis alt gik godt, send brugeren videre til betalingssiden
        // Brug v√¶rdierne direkte fra formularen, s√• vi aldrig f√•r "undefined"
        const params = new URLSearchParams({
          aktivitet,
          antal,
          dato,
          tid
        });

        window.location.href = "/betaling.html?" + params.toString();

      } catch (err) {
        console.error(err);
        besked.textContent = "Netv√¶rksfejl - kunne ikke kontakte serveren.";
      }
    });
  </script>

</body>
</html>
